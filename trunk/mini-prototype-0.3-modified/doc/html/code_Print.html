<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="PrettyPrinter" rel="Chapter" href="PrettyPrinter.html">
<link title="InfiniteArray" rel="Chapter" href="InfiniteArray.html">
<link title="Misc" rel="Chapter" href="Misc.html">
<link title="Env" rel="Chapter" href="Env.html">
<link title="Positions" rel="Chapter" href="Positions.html">
<link title="Mark" rel="Chapter" href="Mark.html">
<link title="UnionFind" rel="Chapter" href="UnionFind.html">
<link title="AstPositions" rel="Chapter" href="AstPositions.html">
<link title="Processing" rel="Chapter" href="Processing.html">
<link title="ParsingExceptions" rel="Chapter" href="ParsingExceptions.html">
<link title="BasicSetEquations" rel="Chapter" href="BasicSetEquations.html">
<link title="IntRank" rel="Chapter" href="IntRank.html">
<link title="CoreAlgebra" rel="Chapter" href="CoreAlgebra.html">
<link title="MultiEquation" rel="Chapter" href="MultiEquation.html">
<link title="Unifier" rel="Chapter" href="Unifier.html">
<link title="Constraint" rel="Chapter" href="Constraint.html">
<link title="Solver" rel="Chapter" href="Solver.html">
<link title="MiniAst" rel="Chapter" href="MiniAst.html">
<link title="MiniAlgebra" rel="Chapter" href="MiniAlgebra.html">
<link title="Print" rel="Chapter" href="Print.html">
<link title="ConstraintPrettyPrinter" rel="Chapter" href="ConstraintPrettyPrinter.html">
<link title="MiniTypingExceptions" rel="Chapter" href="MiniTypingExceptions.html">
<link title="MiniPrettyPrinter" rel="Chapter" href="MiniPrettyPrinter.html">
<link title="MiniKindInferencer" rel="Chapter" href="MiniKindInferencer.html">
<link title="MiniTypingEnvironment" rel="Chapter" href="MiniTypingEnvironment.html">
<link title="MiniTypes" rel="Chapter" href="MiniTypes.html">
<link title="MiniInfer" rel="Chapter" href="MiniInfer.html">
<link title="MiniSyntacticAnalysis" rel="Chapter" href="MiniSyntacticAnalysis.html">
<link title="MiniConstraintPrinter" rel="Chapter" href="MiniConstraintPrinter.html">
<link title="MiniSolver" rel="Chapter" href="MiniSolver.html">
<link title="Errors" rel="Chapter" href="Errors.html"><title>Print</title>
</head>
<body>
<code class="code"></code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;Mini,&nbsp;a&nbsp;type&nbsp;inference&nbsp;engine&nbsp;based&nbsp;on&nbsp;constraint&nbsp;solving.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Copyright&nbsp;(C)&nbsp;2006.&nbsp;François&nbsp;Pottier,&nbsp;Yann&nbsp;Régis-Gianas&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;and&nbsp;Didier&nbsp;Rémy.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;This&nbsp;program&nbsp;is&nbsp;free&nbsp;software;&nbsp;you&nbsp;can&nbsp;redistribute&nbsp;it&nbsp;and/or&nbsp;modify&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;it&nbsp;under&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;GNU&nbsp;General&nbsp;Public&nbsp;License&nbsp;as&nbsp;published&nbsp;by&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;the&nbsp;Free&nbsp;Software&nbsp;Foundation;&nbsp;version&nbsp;2&nbsp;of&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;This&nbsp;program&nbsp;is&nbsp;distributed&nbsp;in&nbsp;the&nbsp;hope&nbsp;that&nbsp;it&nbsp;will&nbsp;be&nbsp;useful,&nbsp;but&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;WITHOUT&nbsp;ANY&nbsp;WARRANTY;&nbsp;without&nbsp;even&nbsp;the&nbsp;implied&nbsp;warranty&nbsp;of&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;MERCHANTABILITY&nbsp;or&nbsp;FITNESS&nbsp;FOR&nbsp;A&nbsp;PARTICULAR&nbsp;PURPOSE.&nbsp;&nbsp;See&nbsp;the&nbsp;GNU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;General&nbsp;Public&nbsp;License&nbsp;for&nbsp;more&nbsp;details.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;You&nbsp;should&nbsp;have&nbsp;received&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;GNU&nbsp;General&nbsp;Public&nbsp;License&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;along&nbsp;with&nbsp;this&nbsp;program;&nbsp;if&nbsp;not,&nbsp;write&nbsp;to&nbsp;the&nbsp;Free&nbsp;Software&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Foundation,&nbsp;Inc.,&nbsp;51&nbsp;Franklin&nbsp;Street,&nbsp;Fifth&nbsp;Floor,&nbsp;Boston,&nbsp;MA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;02110-1301&nbsp;USA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
<span class="comment">(*&nbsp;$Id:&nbsp;print.ml&nbsp;421&nbsp;2006-12-22&nbsp;09:27:42Z&nbsp;regisgia&nbsp;$&nbsp;*)</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** This module provides a simple pretty-printer for the terms
    maintained by a unifier.
<p>

    We follow the convention that types and type schemes are represented
    using the same data structure. In the case of type schemes, universally
    quantified type variables are distinguished by the fact that their rank
    is <code class="code">none</code>. The pretty-printer binds these variables locally, while other
    (non-quantified) type variables are considered part of a global namespace. 
*)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Misc</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">MiniAlgebra</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">MiniAst</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">CoreAlgebra</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">MultiEquation</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** The things that we print are <code class="code">variable</code>s, that is, entry points
    for types or type schemes. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">type</span>&nbsp;variable&nbsp;=&nbsp;<span class="constructor">MultiEquation</span>.variable<br>
<br>
<span class="keyword">type</span>&nbsp;term&nbsp;=&nbsp;<span class="constructor">MultiEquation</span>.crterm<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <code class="code">name_from_int i</code> turns the integer <code class="code">i</code> into a type variable name. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;name_from_int&nbsp;i&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;i&nbsp;&lt;&nbsp;26&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.make&nbsp;1&nbsp;(<span class="constructor">Char</span>.chr&nbsp;(0x61&nbsp;+&nbsp;i))<br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;name_from_int&nbsp;(i&nbsp;/&nbsp;26&nbsp;-&nbsp;1)&nbsp;^&nbsp;name_from_int&nbsp;(i&nbsp;<span class="keyword">mod</span>&nbsp;26)<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <code class="code">gi</code> is the last consumed number. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;gi&nbsp;=<br>
&nbsp;&nbsp;&nbsp;ref&nbsp;(-1)<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <code class="code">ghistory</code> is a mapping from variables to variable names. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;ghistory&nbsp;=<br>
&nbsp;&nbsp;ref&nbsp;[]<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <code class="code">reset()</code> clears the global namespace, which is implemented
   by <code class="code">gi</code> and <code class="code">ghistory</code>. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;reset&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;gi&nbsp;:=&nbsp;-1;<br>
&nbsp;&nbsp;ghistory&nbsp;:=&nbsp;[]<br>
<br>
<span class="keyword">type</span>&nbsp;arg&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Arg</span>&nbsp;<span class="keyword">of</span>&nbsp;(<span class="constructor">MultiEquation</span>.variable&nbsp;*&nbsp;string&nbsp;*&nbsp;arg&nbsp;list&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;bool&nbsp;*&nbsp;associativity&nbsp;*&nbsp;bool)<br>
<br>
<span class="keyword">let</span>&nbsp;paren&nbsp;b&nbsp;e&nbsp;=&nbsp;<span class="keyword">if</span>&nbsp;b&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"("</span>^^e^^<span class="string">")"</span>&nbsp;<span class="keyword">else</span>&nbsp;e<br>
<br>
<span class="keyword">let</span>&nbsp;string_of_label&nbsp;=&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">function</span>&nbsp;<span class="constructor">LName</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <code class="code">print is_type_scheme v</code> returns a printable representation of
    the type or type scheme whose entry point is <code class="code">v</code>. The parameter
    <code class="code">is_type_scheme</code> tells whether <code class="code">v</code> should be interpreted as a
    type or as a type scheme. Recursive types are dealt with by
    printing inline equations. Consecutive calls to <code class="code">print</code> share
    the same variable naming conventions, unless <code class="code">reset</code> is called
    in between. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;printer&nbsp;?user_name_from_int&nbsp;is_type_scheme&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name_from_int&nbsp;=&nbsp;default&nbsp;name_from_int&nbsp;user_name_from_int&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** Create marks to deal with cycles. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;visiting&nbsp;=&nbsp;<span class="constructor">Mark</span>.fresh()<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;hit&nbsp;=&nbsp;<span class="constructor">Mark</span>.fresh()&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** Create a local namespace for this type scheme. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;(-1)<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;history&nbsp;=&nbsp;ref&nbsp;[]&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** <code class="code">name v</code> looks up or assigns a name to the variable <code class="code">v</code>. When
      dealing with a type scheme, then the local or global namespace
      is used, depending on whether <code class="code">v</code> is universally quantified or
      not. When dealing with a type, only the global namespace is
      used. *)</span></td></tr></table><code class="code"><br>
<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FIXME:&nbsp;necessite&nbsp;du&nbsp;prefixe&nbsp;?&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;var_name&nbsp;hits&nbsp;visited&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;desc&nbsp;=&nbsp;<span class="constructor">UnionFind</span>.find&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;autoname&nbsp;()&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prefix,&nbsp;c,&nbsp;h&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;is_type_scheme&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;<span class="constructor">IntRank</span>.compare&nbsp;desc.rank&nbsp;<span class="constructor">IntRank</span>.none&nbsp;=&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span>,&nbsp;i,&nbsp;history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"_"</span>,&nbsp;gi,&nbsp;ghistory<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Misc</span>.assocp&nbsp;(<span class="constructor">UnionFind</span>.equivalent&nbsp;v)&nbsp;!h&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;c;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;<span class="comment">(*&nbsp;prefix&nbsp;^&nbsp;*)</span>&nbsp;name_from_int&nbsp;!c&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;desc.name&nbsp;&lt;-&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">TName</span>&nbsp;result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h&nbsp;:=&nbsp;(v,&nbsp;result)&nbsp;::&nbsp;!h;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;desc.name&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">TName</span>&nbsp;name)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;desc.kind&nbsp;&lt;&gt;&nbsp;<span class="constructor">Constant</span>&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Misc</span>.assocp&nbsp;(<span class="constructor">UnionFind</span>.equivalent&nbsp;v)&nbsp;!history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;history&nbsp;:=&nbsp;(v,&nbsp;name)&nbsp;::&nbsp;!history;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;autoname&nbsp;())<br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;("["^string_of_int&nbsp;desc.rank^"]")*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;(match&nbsp;desc.kind&nbsp;with&nbsp;Constant&nbsp;-&gt;&nbsp;"#"&nbsp;|&nbsp;Rigid&nbsp;-&gt;&nbsp;"!"&nbsp;|&nbsp;_&nbsp;-&gt;&nbsp;"?")&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Term&nbsp;traversal.&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;print_variable&nbsp;?use_user_def&nbsp;hits&nbsp;visited&nbsp;v&nbsp;=&nbsp;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_hit&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Mark</span>.same&nbsp;(<span class="constructor">UnionFind</span>.find&nbsp;v).mark&nbsp;hit<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;is_visited&nbsp;v&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Mark</span>.same&nbsp;(<span class="constructor">UnionFind</span>.find&nbsp;v).mark&nbsp;visiting<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;var_or_sym&nbsp;v&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;variable_name&nbsp;v&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">TName</span>&nbsp;name)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;as_symbol&nbsp;(<span class="constructor">TName</span>&nbsp;name)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;sym&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(v,&nbsp;name,&nbsp;[],&nbsp;infix&nbsp;sym,&nbsp;associativity&nbsp;sym,&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(v,&nbsp;var_name&nbsp;hits&nbsp;visited&nbsp;v,&nbsp;[],&nbsp;<span class="keyword">false</span>,&nbsp;<span class="constructor">NonAssoc</span>,&nbsp;<span class="keyword">false</span>))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(v,&nbsp;var_name&nbsp;hits&nbsp;visited&nbsp;v,&nbsp;[],&nbsp;<span class="keyword">false</span>,&nbsp;<span class="constructor">NonAssoc</span>,&nbsp;<span class="keyword">false</span>))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;desc&nbsp;=&nbsp;<span class="constructor">UnionFind</span>.find&nbsp;v&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;If&nbsp;this&nbsp;variable&nbsp;was&nbsp;visited&nbsp;already,&nbsp;we&nbsp;mark&nbsp;it&nbsp;as&nbsp;``hit<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;again'',&nbsp;so&nbsp;as&nbsp;to&nbsp;record&nbsp;the&nbsp;fact&nbsp;that&nbsp;we&nbsp;need&nbsp;to&nbsp;print&nbsp;an<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;equation&nbsp;at&nbsp;that&nbsp;node&nbsp;when&nbsp;going&nbsp;back&nbsp;up.&nbsp;*)</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;is_hit&nbsp;v&nbsp;<span class="keywordsign">||</span>&nbsp;is_visited&nbsp;v&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;desc.mark&nbsp;&lt;-&nbsp;hit;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var_or_sym&nbsp;v&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;If&nbsp;this&nbsp;variable&nbsp;was&nbsp;never&nbsp;visited,&nbsp;we&nbsp;mark&nbsp;it&nbsp;as&nbsp;``being<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;visited''&nbsp;before&nbsp;processing&nbsp;it,&nbsp;so&nbsp;as&nbsp;to&nbsp;detect&nbsp;cycles.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If,&nbsp;when&nbsp;we&nbsp;are&nbsp;done&nbsp;with&nbsp;this&nbsp;variable,&nbsp;its&nbsp;mark&nbsp;has<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;changed&nbsp;to&nbsp;``hit&nbsp;again'',&nbsp;then&nbsp;it&nbsp;must&nbsp;be&nbsp;part&nbsp;of&nbsp;a&nbsp;cycle,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;we&nbsp;annotate&nbsp;it&nbsp;with&nbsp;an&nbsp;inline&nbsp;equation.&nbsp;*)</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">begin</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;desc.mark&nbsp;&lt;-&nbsp;visiting;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;desc.structure&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;var_or_sym&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(v',&nbsp;name,&nbsp;args,&nbsp;infix,&nbsp;assoc,&nbsp;p)&nbsp;<span class="keyword">as</span>&nbsp;r&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_term&nbsp;hits&nbsp;visited&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;is_hit&nbsp;v&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vname&nbsp;=&nbsp;var_name&nbsp;hits&nbsp;visited&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(v,&nbsp;vname^<span class="string">"&nbsp;="</span>,&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="constructor">Arg</span>&nbsp;(v',&nbsp;name,&nbsp;args,&nbsp;infix,&nbsp;assoc,&nbsp;p)&nbsp;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">false</span>,&nbsp;assoc,&nbsp;<span class="keyword">true</span>)&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;(desc.mark&nbsp;&lt;-&nbsp;<span class="constructor">Mark</span>.none;&nbsp;r)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;print_term&nbsp;?use_user_def&nbsp;hits&nbsp;visited&nbsp;t&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;at_left&nbsp;&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">|</span>&nbsp;[&nbsp;x&nbsp;]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">assert</span>&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;at_right&nbsp;=&nbsp;<span class="keyword">function</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">|</span>&nbsp;[&nbsp;x&nbsp;]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">assert</span>&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;print&nbsp;=&nbsp;<span class="keyword">function</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">App</span>&nbsp;(t1,&nbsp;t2)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(op1,&nbsp;name1,&nbsp;args1,&nbsp;infix1,&nbsp;assoc1,&nbsp;force_paren1)&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_variable&nbsp;hits&nbsp;visited&nbsp;t1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;(op2,&nbsp;name2,&nbsp;args2,&nbsp;infix2,&nbsp;assoc2,&nbsp;force_paren2)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_variable&nbsp;hits&nbsp;visited&nbsp;t2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;priority&nbsp;name&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;as_symbol&nbsp;name&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;sym&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;priority&nbsp;sym<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;-1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;paren_t2&nbsp;=&nbsp;force_paren2&nbsp;<span class="keywordsign">||</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;are_equivalent&nbsp;op1&nbsp;op2&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(assoc2&nbsp;=&nbsp;<span class="constructor">AssocLeft</span>&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;at_right&nbsp;args1)&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">||</span>&nbsp;(assoc2&nbsp;=&nbsp;<span class="constructor">AssocRight</span>&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;at_left&nbsp;args1)&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(priority&nbsp;(<span class="constructor">TName</span>&nbsp;name2)&nbsp;&gt;&nbsp;priority&nbsp;(<span class="constructor">TName</span>&nbsp;name1))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(op1,&nbsp;name1,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(args1&nbsp;@&nbsp;[&nbsp;<span class="constructor">Arg</span>&nbsp;(op2,&nbsp;name2,&nbsp;args2,&nbsp;infix2,&nbsp;assoc2,&nbsp;paren_t2)]),&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;infix1,&nbsp;assoc1,&nbsp;force_paren1)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Var</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;print_variable&nbsp;hits&nbsp;visited&nbsp;v<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">RowCons</span>&nbsp;(label,&nbsp;typ,&nbsp;r)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;typv&nbsp;=&nbsp;print_variable&nbsp;hits&nbsp;visited&nbsp;typ&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(variable&nbsp;<span class="constructor">Flexible</span>&nbsp;(),&nbsp;<span class="string">";"</span>,&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Arg</span>&nbsp;(variable&nbsp;<span class="constructor">Flexible</span>&nbsp;(),&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string_of_label&nbsp;(<span class="constructor">RowLabel</span>.export&nbsp;label)^<span class="string">":"</span>,&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="constructor">Arg</span>&nbsp;typv&nbsp;],&nbsp;<span class="keyword">false</span>,&nbsp;<span class="constructor">NonAssoc</span>,&nbsp;<span class="keyword">false</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Arg</span>&nbsp;(print_variable&nbsp;hits&nbsp;visited&nbsp;r)],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">true</span>,&nbsp;<span class="constructor">NonAssoc</span>,&nbsp;<span class="keyword">false</span>)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">RowUniform</span>&nbsp;typ&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(variable&nbsp;<span class="constructor">Flexible</span>&nbsp;(),&nbsp;<span class="string">"\\"</span>,&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="constructor">Arg</span>&nbsp;(print_variable&nbsp;hits&nbsp;visited&nbsp;typ)&nbsp;],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">false</span>,&nbsp;<span class="constructor">NonAssoc</span>,&nbsp;<span class="keyword">false</span>)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>&nbsp;print&nbsp;t<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prefix&nbsp;hits&nbsp;visited&nbsp;()&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;is_type_scheme&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!history&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;history&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.fold_left&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;quantifiers&nbsp;(v,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quantifiers&nbsp;^&nbsp;<span class="string">"&nbsp;"</span>&nbsp;^&nbsp;(var_name&nbsp;hits&nbsp;visited&nbsp;v))&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"forall"</span>&nbsp;(<span class="constructor">List</span>.rev&nbsp;history)&nbsp;^&nbsp;<span class="string">".&nbsp;"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">""</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">in</span>&nbsp;<span class="keyword">let</span>&nbsp;as_string&nbsp;f&nbsp;r&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;loop&nbsp;(<span class="constructor">Arg</span>&nbsp;(_,&nbsp;name,&nbsp;args,&nbsp;infix,&nbsp;assoc,&nbsp;is_paren))&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;args&nbsp;=&nbsp;[]&nbsp;<span class="keyword">then</span>&nbsp;name&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paren&nbsp;is_paren<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;infix&nbsp;<span class="keyword">then</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_separated_list&nbsp;(<span class="string">"&nbsp;"</span>^^name^^<span class="string">"&nbsp;"</span>)&nbsp;loop&nbsp;args<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;assoc&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">EnclosedBy</span>&nbsp;(t,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;name)&nbsp;^^<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;args&nbsp;&lt;&gt;&nbsp;[]&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"&nbsp;"</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">""</span>)^^<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(print_separated_list&nbsp;<span class="string">"&nbsp;"</span>&nbsp;loop&nbsp;args)^^<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;assoc&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">EnclosedBy</span>&nbsp;(_,t)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"&nbsp;"</span>^t&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hits,&nbsp;visited&nbsp;=&nbsp;ref&nbsp;[],&nbsp;ref&nbsp;[]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(op,&nbsp;name,&nbsp;args,&nbsp;infix,&nbsp;assoc,&nbsp;_)&nbsp;=&nbsp;f&nbsp;hits&nbsp;visited&nbsp;r&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prefix&nbsp;hits&nbsp;visited&nbsp;()&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;loop&nbsp;(<span class="constructor">Arg</span>&nbsp;(op,&nbsp;name,&nbsp;args,&nbsp;infix,&nbsp;assoc,&nbsp;<span class="keyword">false</span>))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(as_string&nbsp;print_variable,&nbsp;as_string&nbsp;print_term)<br>
<br>
<span class="keyword">let</span>&nbsp;print_term&nbsp;?user_name_from_int&nbsp;b&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;t&nbsp;=&nbsp;explode&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;(snd&nbsp;(printer&nbsp;?user_name_from_int:user_name_from_int&nbsp;b))&nbsp;t<br>
<br>
<span class="keyword">let</span>&nbsp;print_variable&nbsp;?user_name_from_int&nbsp;b&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;(fst&nbsp;(printer&nbsp;?user_name_from_int:user_name_from_int&nbsp;b))&nbsp;v<br>
<br>
</code></body></html>